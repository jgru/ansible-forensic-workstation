---
- name: Update and upgrade apt packages
  become: yes
  apt:
    upgrade: False
    update_cache: yes

- name: Install imaging tools
  apt:
    pkg:
       - hdparm
       - ewf-tools
       - libewf-dev
       - dcfldd
       - dc3dd
       - guymager
       - tableau-parm  # to to interact with tableau writeblockers
  become: yes

- name: Install image utils
  apt:
    pkg:
       - libafflib-dev
       - afflib-tools
       - kpartx
       - qemu
       - qemu-utils
       - xmount
       - libfuse-dev
       - plaso # timelining
  become: yes

- name: Install carving and data recovery utilities
  apt:
    pkg:
       - foremost
       - scalpel # tsk's carver
       - ext4magic # recover ext3 and ext4 files
       - extundelete # recover deleted files from ext journal
       - ntfs-3g # ntfs
       - scrounge-ntfs # rescue data from corrupted NTFS partitions
       - testdisk  # contains photorec also
  become: yes

- name: Download Gary Kesslers bsparser
  get_url:
      url: https://www.garykessler.net/software/bsparser_v3.1.zip
      dest: /tmp/
      checksum: sha1:e210994cebdffbe079f934de1ccd9bb2229a3619

- name: Unarchive BSParser .zip-file
  unarchive:
    src: /tmp/bsparser_v3.1.zip
    dest: /tmp/
    remote_src: yes

- name: Copy bsparser to /usr/local/bin
  copy:
    remote_src: yes
    src: "/tmp/bsparser.pl"
    dest: "/usr/local/bin/bsparser"
    mode: "0775"
    owner: "{{ ansible_user }}"

- name: Download Gary Kesslers FAT directory parser
  get_url:
      url: https://www.garykessler.net/software/dirparser_v2.1.zip
      dest: /tmp/
      checksum: sha1:9d15d4a6319ac60fc925b60010445b7b75cb40e8

- name: Unarchive dirparser .zip-file
  unarchive:
    src: /tmp/dirparser_v2.1.zip
    dest: /tmp/
    remote_src: yes

- name: Copy dirparser to /usr/local/bin
  copy:
    remote_src: yes
    src: "/tmp/dirparser.pl"
    dest: "/usr/local/bin/bsparser"
    mode: "0775"
    owner: "{{ ansible_user }}"

- name: Download Gary Kesslers GPT parser
  get_url:
      url: https://www.garykessler.net/software/gptparser_v1.4beta.zip
      dest: /tmp/
      checksum: sha1:5fe142bf783ffdab829291a91a46c5095fa2403a

- name: Unarchive gpt .zip-file
  unarchive:
    src: /tmp/gptparser_v1.4beta.zip
    dest: /tmp/
    remote_src: yes

- name: Copy gptparser to /usr/local/bin
  copy:
    remote_src: yes
    src: "/tmp/gptparser.pl"
    dest: "/usr/local/bin/gptparser"
    mode: "0775"
    owner: "{{ ansible_user }}"

- name: Download Gary Kesslers MBR parser
  get_url:
      url: https://www.garykessler.net/software/mbrparser_v2.1.zip
      dest: /tmp/
      checksum: sha1:b6cee0e7eb35a0a499d1d0e18bd78dd719bcc6af

- name: Unarchive mbrparser .zip-file
  unarchive:
    src: /tmp/mbrparser_v2.1.zip
    dest: /tmp/
    remote_src: yes

- name: Copy mbrparser to /usr/local/bin
  copy:
    remote_src: yes
    src: "/tmp/mbrparser.pl"
    dest: "/usr/local/bin/mbrparser"
    mode: "0775"
    owner: "{{ ansible_user }}"

- name: Install hashing utils
  apt:
    pkg:
       - hashrat # directory, recursive hashing
       - hashdeep # fuzzy hashing
       - rhash # wide range of hashsum
       - ssdeep # content aware
  become: yes

- name: Install content utils
  apt:
    pkg:
       - binwalk
       - missidentify # search for windows PEs
       - p7zip-full  # 7zip
       - shed # Hex viewer
       - sqlitebrowser
       - tofrodos # from DOS; to DOS LF conversion
       - winregfs # FUSE-based FS driver that enables accessing Registry
       - mpack # unpacking of .emls
       - libemail-outlook-message-perl # conversion of .msgs
       - pcre2-utils # perl compatible grep syntax (pcre2grep...)

  become: yes

- name: Install Autopsy's dependencies
  apt:
    pkg:
       - libafflib-dev
       - libbfio-dev
       - libc3p0-java
       - libewf-dev
  become: yes

# Add apt signing key for bellsoft packaged OpenJDK with Open JFX
- name: Add an apt signing key to a specific keyring file
  apt_key:
    url: https://download.bell-sw.com/pki/GPG-KEY-bellsoft
    state: present
  become: yes

  # Add specified repository into sources list using specified filename.
- name: Add Bellsoft repo into sources list
  apt_repository:
    repo: deb https://apt.bell-sw.com/ stable main
    state: present
    filename: bellsoft
  become: yes

- name: Install Autopsy's Java dependencies
  apt:
    pkg:
       - libpostgresql-jdbc-java
       - bellsoft-java8-full
    update_cache: yes
  become: yes

- name: Update alternatives for java
  alternatives:
    name: java
    path: "/usr/lib/jvm/bellsoft-java8-full-amd64/bin/java"
    link: "/usr/bin/java"

- name: set java home as environment variable
  lineinfile:
    insertafter: EOF
    path: "/etc/environment"
    line: "JAVA_HOME=/usr/lib/jvm/bellsoft-java8-full-amd64"

- name: Install Sleuthkit with Java bindings - sleuthkit-java.deb
  apt:
    deb: https://github.com/sleuthkit/sleuthkit/releases/download/sleuthkit-{{ sleuthkit_version }}/sleuthkit-java_{{ sleuthkit_version }}-1_amd64.deb
  become: yes

- name: Unarchive Autopsy-zip-file
  unarchive:
    src: https://github.com/sleuthkit/autopsy/releases/download/autopsy-{{ autopsy_version }}/autopsy-{{ autopsy_version }}.zip
    dest: /opt/
    remote_src: yes

- name: Ensure Autopsy's directory permission
  file:
    path: /opt/autopsy-{{ autopsy_version }}
    state: directory
    owner: "{{ ansible_user }}"
    mode: "0755"

- name: Execute setup script unix_setup.sh
  shell: sh /opt/autopsy-{{ autopsy_version }}/unix_setup.sh
  args:
    chdir: /opt/autopsy-{{ autopsy_version }}

- name: Recursively change ownership of a directory
  file:
    path: /opt/autopsy-{{ autopsy_version }}
    state: directory
    recurse: yes
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Create symbolic link to run autopsy
  file:
    src: "/opt/autopsy-{{ autopsy_version }}/bin/autopsy"
    path: "/usr/local/bin/autopsy"
    state: link
    owner: "{{ ansible_user }}"
